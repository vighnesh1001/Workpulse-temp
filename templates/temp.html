{% extends 'base.html' %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-dag@0.6"></script>

<style>
  .kanban-container {
    display: flex;
    gap: 20px;
    margin-top: 20px;
  }

  .kanban-column {
    width: 32%;
    background: #f7f7f7;
    border-radius: 8px;
    padding: 10px;
  }

  .kanban-list {
    background: #ffffff;
    min-height: 200px;
    padding: 10px;
    border-radius: 6px;
  }

  .kanban-card {
    background: #e9ecef;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 10px;
    cursor: grab;
  }

  /* Online/Offline dots */
  .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
  }
  .online { background: #2ecc71; }
  .offline { background: #e74c3c; }
</style>


<div class="card">
  <h2>{{ group.name }}</h2>
  <p class="muted">{{ group.description or 'No description' }}</p>

  <h3>Members</h3>
  <ul>
    {% for m in members %}
      {% set is_online = m.id in online_users %}
      <li data-user-id="{{ m.id }}">
        <span class="status-dot {{ 'online' if is_online else 'offline' }}"></span>

        {{ m.username }}

        {% set membership = m.memberships 
          |selectattr('group_id','equalto',group.id)
          |list 
          |first %}
        <span class="muted">({{ membership.role }})</span>

        <small class="muted status-text">
          ‚Äî {{ 'Online' if is_online else 'Offline' }}
        </small>
      </li>
    {% endfor %}
  </ul>

  {% if current_user.id == group.admin_id %}
    <a href="{{ url_for('add_member', group_id=group.id) }}" class="btn">Add Member</a>
  {% endif %}
</div>


<div class="card" style="margin-top:20px;">
  <h3>Group Messages</h3>
  <a href="{{ url_for('group_messages', group_id=group.id) }}" class="btn">Open Chat</a>
</div>


{% if current_user.id == group.admin_id %}
<div class="card" style="margin-top:20px;">
  <h3>Admin Task Overview</h3>

  <h4>Pending Tasks</h4>
  {% if pending_tasks %}
    <ul style="padding-left:16px;">
      {% for task in pending_tasks %}
        <li>
          <a href="{{ url_for('task_detail', group_id=group.id, task_id=task.id) }}">
            {{ task.title }}
          </a>
          ‚Äî {{ task.status }}
          {% if task.due_date %}
            <br><small>Due: {{ task.due_date.strftime('%Y-%m-%d') }}</small>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No pending tasks üéâ</p>
  {% endif %}

  <!-- Kanban Board -->
  <h3 style="margin-top:25px;">Kanban Board</h3>

  <div class="kanban-container">

    <!-- To Do -->
    <div class="kanban-column">
      <h3>To Do</h3>
      <div id="todo" class="kanban-list">
        {% for t in todo_tasks %}
        <div class="kanban-card"
             data-id="{{ t.id }}"
             data-status="{{ t.status }}">
          <strong>{{ t.title }}</strong><br>
          <small>Priority: {{ t.priority }}</small>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- In Progress -->
    <div class="kanban-column">
      <h3>In Progress</h3>
      <div id="inprogress" class="kanban-list">
        {% for t in inprogress_tasks %}
        <div class="kanban-card"
             data-id="{{ t.id }}"
             data-status="{{ t.status }}">
          <strong>{{ t.title }}</strong><br>
          <small>Priority: {{ t.priority }}</small>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Done -->
    <div class="kanban-column">
      <h3>Done</h3>
      <div id="done" class="kanban-list">
        {% for t in done_tasks %}
        <div class="kanban-card"
             data-id="{{ t.id }}"
             data-status="{{ t.status }}">
          <strong>{{ t.title }}</strong><br>
          <small>Priority: {{ t.priority }}</small>
        </div>
        {% endfor %}
      </div>
    </div>

  </div>

  <script>
  function setupColumn(columnId, newStatus) {
    const column = document.getElementById(columnId);

    new Sortable(column, {
      group: "kanban",
      animation: 180,

      onAdd: function (evt) {
        evt.item.dataset.status = newStatus;
      },

      onChoose: function () {
        column.classList.add("drag-over");
      },
      onUnchoose: function () {
        column.classList.remove("drag-over");
      },

      onEnd: function (evt) {
        column.classList.remove("drag-over");
        const card = evt.item;
        const taskId = card.dataset.id;

        fetch("/task/update_status", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: taskId,
            status: newStatus,
          }),
        });
      },
    });
  }

  setupColumn('todo', 'todo');
  setupColumn('inprogress', 'in-progress');
  setupColumn('done', 'done');
  </script>


  <h4 style="margin-top:15px;">Overdue Tasks</h4>
  {% if overdue_tasks %}
    <ul style="padding-left:16px;">
      {% for task in overdue_tasks %}
        <li style="color: #c0392b;">
          <a href="{{ url_for('task_detail', group_id=group.id, task_id=task.id) }}" style="color:#c0392b;">
            {{ task.title }}
          </a>
          ‚Äî {{ task.status }}
          <br><small>Due was: {{ task.due_date.strftime('%Y-%m-%d') }}</small>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No overdue tasks üëè</p>
  {% endif %}
</div>
{% endif %}

<p>ToDo count: {{ todo_tasks|length }}</p>
<p>InProgress count: {{ inprogress_tasks|length }}</p>
<p>Done count: {{ done_tasks|length }}</p>


<div class="card" style="margin-top:20px;">
  <h3>Tasks</h3>
  <a href="{{ url_for('create_task', group_id=group.id) }}" class="btn">Create Task</a>

  {% if group.tasks %}
    <ul style="padding-left:16px;">
      {% for task in group.tasks %}
        <li style="margin-bottom:10px;">
          <strong>
            <a href="{{ url_for('task_detail', group_id=group.id, task_id=task.id) }}">
              {{ task.title }}
            </a>
          </strong>
          ‚Äî {{ task.status }}
          <br>
          <small>Created by {{ task.creator.username }}</small>

          {% if task.assigned_to %}
            <br><small>Assigned to {{ task.assignee.username }}</small>
          {% endif %}

          {% if task.due_date %}
            <br><small>Due: {{ task.due_date.strftime('%Y-%m-%d') }}</small>
          {% else %}
            <br><small>Due: No deadline</small>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No tasks yet.</p>
  {% endif %}
</div>

<!-- ---------- TASK DEPENDENCY GRAPH (ZOOMABLE + SCROLLABLE) ---------- -->
<div class="card" style="margin-top:20px;">
  <h3>Task Dependency Graph</h3>
  <p class="muted">Shows how tasks depend on each other. Scroll, zoom, drag freely.</p>

  <div id="dependency-graph-wrapper"
       style="width:100%; height:420px; overflow:auto; border:1px solid #ddd; border-radius:8px; position:relative;">
      <svg id="dependency-graph" width="1500" height="1200" style="background:#fafafa;"></svg>
  </div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
(function () {

    const tasks = [
        {% for t in group.tasks %}
        {
            id: {{ t.id }},
            title: "{{ t.title|replace('"','') }}",
            status: "{{ t.status }}",
            depends_on: {% if t.dependency_id %} {{ t.dependency_id }} {% else %} null {% endif %}
        },
        {% endfor %}
    ];

    const nodes = tasks.map(t => ({
        id: t.id,
        name: t.title,
        status: t.status
    }));

    const links = tasks
        .filter(t => t.depends_on)
        .map(t => ({
            source: t.depends_on,
            target: t.id
        }));

    const svg = d3.select("#dependency-graph");
    const g = svg.append("g");

    const zoom = d3.zoom()
        .scaleExtent([0.2, 3])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
        });

    svg.call(zoom);

    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links)
            .id(d => d.id)
            .distance(160))
        .force("charge", d3.forceManyBody().strength(-600))
        .force("center", d3.forceCenter(750, 600));

    const color = (status) => {
        if (status === "done") return "#2ecc71";
        if (status === "in-progress") return "#f1c40f";
        return "#95a5a6";
    };

    svg.append("defs").append("marker")
        .attr("id", "arrow")
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 25)
        .attr("markerWidth", 8)
        .attr("markerHeight", 8)
        .attr("orient", "auto")
        .append("path")
        .attr("d", "M0,-5L10,0L0,5")
        .attr("fill", "#777");

    const link = g.append("g")
        .selectAll("line")
        .data(links)
        .enter()
        .append("line")
        .attr("stroke", "#777")
        .attr("stroke-width", 2)
        .attr("marker-end", "url(#arrow)");

    const node = g.append("g")
        .selectAll("g")
        .data(nodes)
        .enter()
        .append("g")
        .call(d3.drag()
            .on("start", dragStart)
            .on("drag", dragged)
            .on("end", dragEnd));

    node.append("circle")
        .attr("r", 26)
        .attr("fill", d => color(d.status))
        .attr("stroke", "#333")
        .attr("stroke-width", 1.4);

    node.append("text")
        .text(d => d.name)
        .attr("x", -20)
        .attr("y", 5)
        .style("font-size", "10px");

    simulation.on("tick", () => {
        link.attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    function dragStart(event) {
        if (!event.active) simulation.alphaTarget(0.4).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
    }
    function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
    }
    function dragEnd(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
    }

})();
</script>

<!-- =================== CUSTOM GANTT CHART =================== -->
<div class="card" style="margin-top:20px;">
    <h3>Project Timeline (Gantt Chart)</h3>
    <p style="color:#555; font-size:14px; margin-top:-6px;">
        Visual timeline of tasks in this group.
    </p>

    <div id="gantt-wrapper">
        <div id="gantt-header"></div>
        <div id="gantt-body"></div>
    </div>
</div>

<style>
    #gantt-wrapper {
        border: 1px solid #ddd;
        border-radius: 12px;
        overflow-x: auto;
        overflow-y: hidden;
        padding: 10px;
        background: #fafafa;
    }

    #gantt-header {
        display: flex;
        position: sticky;
        top: 0;
        background: #fafafa;
        z-index: 20;
        padding-bottom: 4px;
        border-bottom: 1px solid #e5e7eb;
    }

    .gantt-day {
        width: 110px;
        text-align: center;
        font-size: 13px;
        font-weight: 600;
        color: #111;
        border-right: 1px solid #eee;
        padding: 4px;
    }

    #gantt-body {
        position: relative;
        min-height: 220px;
        background: #fff;
    }

    .gantt-row {
        height: 44px;
        border-bottom: 1px solid #eee;
        position: relative;
    }

    .task-bar {
        position: absolute;
        height: 22px;
        border-radius: 6px;
        padding: 0 8px;
        display: flex;
        align-items: center;
        color: #fff;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    }

    /* Strong, visible colors */
    .todo-bar        { background: #6b7280; }  /* Gray */
    .inprogress-bar  { background: #2563eb; }  /* Blue */
    .done-bar        { background: #16a34a; }  /* Green */
    .overdue-bar     { background: #dc2626; }  /* Red */

    #today-line {
        position: absolute;
        width: 2px;
        background: #dc2626;
        top: 0;
        bottom: 0;
        z-index: 10;
    }
</style>

<script>
(function() {
    const tasks = [
        {% for t in group.tasks %}
        {
            title: "{{ t.title|replace('"','') }}",
            status: "{{ t.status }}",
            start: "{{ t.created_at.date() }}",
            end: "{{ (t.due_date.date() if t.due_date else t.created_at.date()) }}"
        },
        {% endfor %}
    ];
    if (tasks.length === 0) return;

    // function parse(d) { return new Date(d + "T00:00:00"); }
    function parse(d) {
    const parts = d.split("-");
    return new Date(Date.UTC(parts[0], parts[1]-1, parts[2]));
}

    const minDate = new Date(Math.min(...tasks.map(t => parse(t.start))));
    const maxDate = new Date(Math.max(...tasks.map(t => parse(t.end))));

    // add a small margin on both sides
    minDate.setDate(minDate.getDate() - 1);
    maxDate.setDate(maxDate.getDate() + 1);

    const ONE_DAY = 1000 * 60 * 60 * 24;
    const totalDays = Math.ceil((maxDate - minDate) / ONE_DAY);

    const header = document.getElementById("gantt-header");
    const body = document.getElementById("gantt-body");

    // ---- Header days ----
    for (let i = 0; i <= totalDays; i++) {
        const d = new Date(minDate);
        d.setDate(minDate.getDate() + i);
        const div = document.createElement("div");
        div.className = "gantt-day";
        div.textContent = d.toLocaleDateString(undefined, { day: "numeric", month: "short" });
        header.appendChild(div);
    }

    // ---- Today marker ----
    const today = new Date();
    if (today >= minDate && today <= maxDate) {
        const offset = Math.floor((today - minDate) / ONE_DAY) * 110;
        const line = document.createElement("div");
        line.id = "today-line";
        line.style.left = offset + "px";
        body.appendChild(line);
    }

    // ---- Render each task ----
    tasks.forEach((t, index) => {
        const row = document.createElement("div");
        row.className = "gantt-row";
        body.appendChild(row);

        const start = parse(t.start);
        const end = parse(t.end);

        const startOffset = Math.floor((start - minDate) / ONE_DAY) * 110;

// ---- FIX: CALCULATE CALENDAR-BASED DURATION ----
const startMidnight = new Date(start.getFullYear(), start.getMonth(), start.getDate());
const endMidnight = new Date(end.getFullYear(), end.getMonth(), end.getDate());

// Number of whole calendar days, INCLUDING the end date (+1)
const rawDays = Math.floor((endMidnight - startMidnight) / ONE_DAY) + 1;

// At least 1 day
const safeDays = rawDays < 1 ? 1 : rawDays;

// Convert days ‚Üí pixels
const duration = safeDays * 110;


        const bar = document.createElement("div");
        bar.className = "task-bar";

        if (t.status === "todo")       bar.classList.add("todo-bar");
        if (t.status === "in-progress") bar.classList.add("inprogress-bar");
        if (t.status === "done")       bar.classList.add("done-bar");

        if (end < today && t.status !== "done") {
            bar.classList.add("overdue-bar");
        }

        bar.style.left = startOffset + "px";
        bar.style.width = duration + "px";
        bar.style.top = (index * 44 + 11) + "px";
        bar.textContent = t.title;

        // --- Hover Tooltip Setup ---
const tooltip = document.getElementById("gantt-tooltip");

bar.addEventListener("mouseenter", (e) => {
    tooltip.style.display = "block";
    
    const startDate = start.toLocaleDateString();
    const endDate   = end.toLocaleDateString();
    const startMidnight = new Date(start.getUTCFullYear(), start.getUTCMonth(), start.getUTCDate());
    const endMidnight   = new Date(end.getUTCFullYear(), end.getUTCMonth(), end.getUTCDate());

    const rawDays = Math.floor((endMidnight - startMidnight) / ONE_DAY) + 1;
    const durationDays = rawDays < 1 ? 1 : rawDays;

    tooltip.innerHTML = `
        <strong>${t.title}</strong><br>
        <small>Status: ${t.status}</small><br>
        <small>Start: ${startDate}</small><br>
        <small>End: ${endDate}</small><br>
        <small>Duration: ${durationDays} day(s)</small>

    `;
});

bar.addEventListener("mousemove", (e) => {
    tooltip.style.left = (e.pageX + 15) + "px";
    tooltip.style.top  = (e.pageY + 15) + "px";
});

bar.addEventListener("mouseleave", () => {
    tooltip.style.display = "none";
});

// Append the bar
body.appendChild(bar);

    });
})();
</script>


<!-- ------------- Group Heatmap (Activity + Deadline) ------------- -->
<div class="card" style="margin-top:20px;">
  <h3>Group Heatmaps</h3>

  <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
    <div>
      <button id="heatmap-type-activity" class="btn btn-sm">Activity</button>
      <button id="heatmap-type-deadline" class="btn btn-sm">Deadline</button>
      <button id="heatmap-type-both" class="btn btn-sm">Both (combined)</button>
    </div>

    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
      <label style="font-size:13px; color:#666;">Months:</label>
      <select id="heatmap-months" style="padding:4px;">
        <option value="3">3</option>
        <option value="6">6</option>
        <option value="12" selected>12</option>
      </select>
    </div>
  </div>
  <a href="{{ url_for('export_report', group_id=group.id) }}"
   class="btn no-loader">
   üìÑ Export Project Report (PDF)
  </a>

  <div id="group-heatmap-container" style="display:flex; gap:12px; overflow-x:auto; padding-bottom:8px;"></div>

  <div style="margin-top:12px; display:flex; gap:18px;">
    <div id="mini-calendar" style="min-width:220px;"></div>
    <div style="flex:1;">
      <p class="muted">Legend: left = activity, right = deadlines (when both shown). Hover tiles for details.</p>
    </div>
  </div>
</div>

<!-- GROUP FILES -->
<div class="card" style="margin-top:20px;">
  <h3>Group Files</h3>

  <form action="{{ url_for('group_files', group_id=group.id) }}" method="post" enctype="multipart/form-data" style="display:flex; gap:8px; align-items:center;">
    <input type="file" name="file" required>
    <button type="submit" class="btn">Upload</button>
    <small class="muted">Allowed: png,jpg,pdf,txt,zip,docx,csv. Max: {{ (config.MAX_CONTENT_LENGTH // (1024*1024)) if config.get('MAX_CONTENT_LENGTH') else 50 }} MB</small>
  </form>

  <div style="margin-top:12px;">
    {% if files %}
      <ul style="padding-left:16px;">
        {% for f in files %}
          <li style="margin-bottom:8px;">
            <a href="{{ url_for('download_group_file', group_id=group.id, file_id=f.id) }}">
              {{ f.original_filename }}
            </a>
            &nbsp;<small class="muted">‚Äî uploaded by {{ f.uploader.username }} on {{ f.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            {% if f.filesize %}
              &nbsp;<small class="muted">({{ (f.filesize/1024)|round(1) }} KB)</small>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">No files uploaded yet.</p>
    {% endif %}
  </div>
</div>

<!-- Heatmap tooltip + styles -->
<div id="heatmap-tooltip" style="
    position: absolute; display:none; z-index:2000;
    background:#222; color:#fff; padding:6px 8px; border-radius:4px; font-size:12px;"></div>

<style>
.g-heat-tile {
  width: 14px; height: 14px;
  border-radius: 3px;
  margin: 2px;
  display: inline-block;
  vertical-align: middle;
  border: 1px solid rgba(0,0,0,0.05);
  cursor:default;
}
.g-month {
  background: #fafafa;
  padding: 8px;
  border-radius:6px;
  box-shadow: 0 1px 0 rgba(0,0,0,0.04);
  min-width: 160px;
}
.g-month h5 { margin:0 0 6px 0; font-size:13px; }
.mini-cal { background:#fff; border-radius:6px; padding:8px; box-shadow:0 1px 0 rgba(0,0,0,0.04); }
.mini-cal .day {
  width:28px; height:28px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  margin:2px;
  border-radius:4px;
  font-size:12px;
}
</style>
<div id="gantt-tooltip" 
     style="
        position:absolute;
        display:none;
        padding:8px 10px;
        background:#111;
        color:#fff;
        font-size:12px;
        border-radius:6px;
        pointer-events:none;
        box-shadow:0 3px 10px rgba(0,0,0,0.3);
        z-index:2000;">
</div>


<script>
(function () {
  const container = document.getElementById("group-heatmap-container");
  const tooltip = document.getElementById("heatmap-tooltip");
  const grpId = {{ group.id }};
  let currentType = "both";
  let months = Number(document.getElementById("heatmap-months").value || 12);

  function colorForActivity(n) {
    if (n <= 0) return "#eee";
    if (n === 1) return "#b2dfdb";
    if (n === 2) return "#4dd0e1";
    if (n === 3) return "#26c6da";
    return "#00acc1";
  }
  function colorForDeadline(n) {
    if (n <= 0) return "#eee";
    if (n === 1) return "#ffd54f";
    if (n === 2) return "#ffb74d";
    if (n === 3) return "#ff8a65";
    return "#ff5252";
  }

  async function fetchHeatmap() {
    const url = `/api/group-heatmap?group_id=${grpId}&type=both&months=${months}`;
    const r = await fetch(url);
    if (!r.ok) {
      console.error("Heatmap fetch failed", r.status);
      return {};
    }
    return await r.json();
  }

  function renderSmallMonth(year, month, dateMap) {
    const monthStart = new Date(year, month, 1);
    const monthName = monthStart.toLocaleString(undefined, { month: "short" });
    const days = new Date(year, month + 1, 0).getDate();

    const wrapper = document.createElement("div");
    wrapper.className = "g-month";
    wrapper.style.minWidth = "140px";

    const title = document.createElement("h5");
    title.textContent = `${monthName} ${year}`;
    wrapper.appendChild(title);

    const row = document.createElement("div");
    for (let d = 1; d <= days; d++) {
      const key = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      const info = dateMap[key] || {activity:0, deadline:0};

      const act = info.activity || 0;
      const dead = info.deadline || 0;

      const tile = document.createElement("div");
      tile.className = "g-heat-tile";

      if (act > 0 && dead > 0) {
        const total = act + dead;
        const pct = Math.round((act/total) * 100);
        const aColor = colorForActivity(act);
        const dColor = colorForDeadline(dead);
        tile.style.background = `linear-gradient(90deg, ${aColor} ${pct}%, ${dColor} ${pct}%)`;
      } else if (act > 0) {
        tile.style.background = colorForActivity(act);
      } else if (dead > 0) {
        tile.style.background = colorForDeadline(dead);
      } else {
        tile.style.background = "#f3f3f3";
      }

      tile.dataset.key = key;
      tile.dataset.act = act;
      tile.dataset.dead = dead;

      tile.addEventListener("mouseenter", () => {
        const a = Number(tile.dataset.act);
        const d = Number(tile.dataset.dead);
        tooltip.style.display = "block";
        tooltip.innerHTML = `${key} ‚Äî Activity: ${a}, Deadlines: ${d}`;
      });
      tile.addEventListener("mousemove", (e) => {
        tooltip.style.left = (e.pageX + 12) + "px";
        tooltip.style.top = (e.pageY + 12) + "px";
      });
      tile.addEventListener("mouseleave", () => { tooltip.style.display = "none"; });

      row.appendChild(tile);
    }

    wrapper.appendChild(row);
    return wrapper;
  }

  async function renderHeatmapAll() {
    container.innerHTML = "";
    const map = await fetchHeatmap();

    const today = new Date();
    const monthsList = [];
    for (let i = months - 1; i >= 0; i--) {
      const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
      monthsList.push({y: d.getFullYear(), m: d.getMonth()});
    }

    monthsList.forEach(({y,m}) => {
      const monthEl = renderSmallMonth(y, m, map);
      container.appendChild(monthEl);
    });

    renderMiniCalendar(map);
  }

  function renderMiniCalendar(dateMap) {
    const mini = document.getElementById("mini-calendar");
    mini.innerHTML = "";
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth();
    const firstDow = new Date(y,m,1).getDay();
    const days = new Date(y, m+1, 0).getDate();

    const wrapper = document.createElement("div");
    wrapper.className = "mini-cal";

    const header = document.createElement("div");
    header.style.fontSize = "13px";
    header.style.marginBottom = "6px";
    header.textContent = now.toLocaleString(undefined, { month: "long", year: "numeric" });
    wrapper.appendChild(header);

    const labels = document.createElement("div");
    labels.style.display = "flex";
    labels.style.gap = "4px";
    labels.style.marginBottom = "6px";
    const shortWeek = ["S","M","T","W","T","F","S"];
    shortWeek.forEach(l => {
      const el = document.createElement("div");
      el.style.width = "28px";
      el.style.fontSize = "11px";
      el.style.textAlign = "center";
      el.textContent = l;
      labels.appendChild(el);
    });
    wrapper.appendChild(labels);

    const grid = document.createElement("div");
    grid.style.display = "flex";
    grid.style.flexWrap = "wrap";
    grid.style.width = "220px";

    for (let i = 0; i < firstDow; i++){
      const blank = document.createElement("div");
      blank.className = "day";
      blank.style.width = "28px";
      blank.style.height = "28px";
      blank.style.visibility = "hidden";
      grid.appendChild(blank);
    }

    for (let d = 1; d <= days; d++) {
      const key = `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
      const info = dateMap[key] || {activity:0, deadline:0};
      const act = info.activity || 0;
      const dead = info.deadline || 0;

      const el = document.createElement("div");
      el.className = "day";
      el.style.width = "28px";
      el.style.height = "28px";
      el.style.display="inline-flex";
      el.style.alignItems="center";
      el.style.justifyContent="center";
      el.style.fontSize="12px";
      el.style.margin = "2px";

      if (dead > 0) el.style.background = colorForDeadline(dead);
      else if (act > 0) el.style.background = colorForActivity(act);
      else el.style.background = "#fff";

      el.textContent = d;
      el.title = `${key} ‚Äî Activity: ${act} / Deadlines: ${dead}`;
      grid.appendChild(el);
    }
    wrapper.appendChild(grid);
    mini.appendChild(wrapper);
  }

  document.getElementById("heatmap-type-activity").addEventListener("click", () => {
    currentType = "activity";
    renderHeatmapAll();
  });
  document.getElementById("heatmap-type-deadline").addEventListener("click", () => {
    currentType = "deadline";
    renderHeatmapAll();
  });
  document.getElementById("heatmap-type-both").addEventListener("click", () => {
    currentType = "both";
    renderHeatmapAll();
  });
  document.getElementById("heatmap-months").addEventListener("change", (e) => {
    months = Number(e.target.value);
    renderHeatmapAll();
  });

  renderHeatmapAll();

})();
</script>

<!-- REALTIME ONLINE/OFFLINE TRACKING -->
<script>
  window.addEventListener("load", function () {
      if (typeof socket === "undefined") {
          console.error("Socket not available on group_detail page");
          return;
      }

      socket.on("presence_update", data => {
          const li = document.querySelector(`li[data-user-id="${data.user_id}"]`);
          if (!li) return;

          const dot = li.querySelector(".status-dot");
          const text = li.querySelector(".status-text");

          if (data.online) {
              dot.classList.remove("offline");
              dot.classList.add("online");
              text.textContent = " ‚Äî Online";
          } else {
              dot.classList.remove("online");
              dot.classList.add("offline");
              text.textContent = " ‚Äî Offline";
          }
      });

      {% if current_user.is_authenticated %}
      socket.emit("join", { user_id: {{ current_user.id }} });
      {% endif %}
  });
</script>

{% endblock %}
